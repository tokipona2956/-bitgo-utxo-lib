var bip66 = require('bip66');
var typeforce = require('typeforce');
var types = require('./types');
var BigInteger = require('bigi');
function ECSignature(r, s) {
    typeforce(types.tuple(types.BigInt, types.BigInt), arguments);
    this.r = r;
    this.s = s;
}
ECSignature.parseCompact = function (buffer) {
    typeforce(types.BufferN(65), buffer);
    var flagByte = buffer.readUInt8(0) - 27;
    if (flagByte !== (flagByte & 7))
        throw new Error('Invalid signature parameter');
    var compressed = !!(flagByte & 4);
    var recoveryParam = flagByte & 3;
    var signature = ECSignature.fromRSBuffer(buffer.slice(1));
    return {
        compressed: compressed,
        i: recoveryParam,
        signature: signature
    };
};
ECSignature.fromRSBuffer = function (buffer) {
    typeforce(types.BufferN(64), buffer);
    var r = BigInteger.fromBuffer(buffer.slice(0, 32));
    var s = BigInteger.fromBuffer(buffer.slice(32, 64));
    return new ECSignature(r, s);
};
ECSignature.fromDER = function (buffer) {
    var decode = bip66.decode(buffer);
    var r = BigInteger.fromDERInteger(decode.r);
    var s = BigInteger.fromDERInteger(decode.s);
    return new ECSignature(r, s);
};
// BIP62: 1 byte hashType flag (only 0x01, 0x02, 0x03, 0x81, 0x82 and 0x83 are allowed)
ECSignature.parseScriptSignature = function (buffer) {
    var hashType = buffer.readUInt8(buffer.length - 1);
    var hashTypeMod = hashType & ~0xc0;
    if (hashTypeMod <= 0x00 || hashTypeMod >= 0x04)
        throw new Error('Invalid hashType ' + hashType);
    return {
        signature: ECSignature.fromDER(buffer.slice(0, -1)),
        hashType: hashType
    };
};
ECSignature.prototype.toCompact = function (i, compressed) {
    if (compressed) {
        i += 4;
    }
    i += 27;
    var buffer = Buffer.alloc(65);
    buffer.writeUInt8(i, 0);
    this.toRSBuffer(buffer, 1);
    return buffer;
};
ECSignature.prototype.toDER = function () {
    var r = Buffer.from(this.r.toDERInteger());
    var s = Buffer.from(this.s.toDERInteger());
    return bip66.encode(r, s);
};
ECSignature.prototype.toRSBuffer = function (buffer, offset) {
    buffer = buffer || Buffer.alloc(64);
    this.r.toBuffer(32).copy(buffer, offset);
    this.s.toBuffer(32).copy(buffer, offset + 32);
    return buffer;
};
ECSignature.prototype.toScriptSignature = function (hashType) {
    var hashTypeMod = hashType & ~0xc0;
    if (hashTypeMod <= 0 || hashTypeMod >= 4)
        throw new Error('Invalid hashType ' + hashType);
    var hashTypeBuffer = Buffer.alloc(1);
    hashTypeBuffer.writeUInt8(hashType, 0);
    return Buffer.concat([this.toDER(), hashTypeBuffer]);
};
module.exports = ECSignature;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWNzaWduYXR1cmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZWNzaWduYXR1cmUuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsSUFBSSxLQUFLLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFBO0FBQzVCLElBQUksU0FBUyxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQTtBQUNwQyxJQUFJLEtBQUssR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUE7QUFFOUIsSUFBSSxVQUFVLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFBO0FBRWhDLFNBQVMsV0FBVyxDQUFFLENBQUMsRUFBRSxDQUFDO0lBQ3hCLFNBQVMsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsS0FBSyxDQUFDLE1BQU0sQ0FBQyxFQUFFLFNBQVMsQ0FBQyxDQUFBO0lBRTdELElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFBO0lBQ1YsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUE7QUFDWixDQUFDO0FBRUQsV0FBVyxDQUFDLFlBQVksR0FBRyxVQUFVLE1BQU07SUFDekMsU0FBUyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUE7SUFFcEMsSUFBSSxRQUFRLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUE7SUFDdkMsSUFBSSxRQUFRLEtBQUssQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDO1FBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyw2QkFBNkIsQ0FBQyxDQUFBO0lBRS9FLElBQUksVUFBVSxHQUFHLENBQUMsQ0FBQyxDQUFDLFFBQVEsR0FBRyxDQUFDLENBQUMsQ0FBQTtJQUNqQyxJQUFJLGFBQWEsR0FBRyxRQUFRLEdBQUcsQ0FBQyxDQUFBO0lBQ2hDLElBQUksU0FBUyxHQUFHLFdBQVcsQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBRXpELE9BQU87UUFDTCxVQUFVLEVBQUUsVUFBVTtRQUN0QixDQUFDLEVBQUUsYUFBYTtRQUNoQixTQUFTLEVBQUUsU0FBUztLQUNyQixDQUFBO0FBQ0gsQ0FBQyxDQUFBO0FBRUQsV0FBVyxDQUFDLFlBQVksR0FBRyxVQUFVLE1BQU07SUFDekMsU0FBUyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUE7SUFFcEMsSUFBSSxDQUFDLEdBQUcsVUFBVSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFBO0lBQ2xELElBQUksQ0FBQyxHQUFHLFVBQVUsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQTtJQUNuRCxPQUFPLElBQUksV0FBVyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQTtBQUM5QixDQUFDLENBQUE7QUFFRCxXQUFXLENBQUMsT0FBTyxHQUFHLFVBQVUsTUFBTTtJQUNwQyxJQUFJLE1BQU0sR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFBO0lBQ2pDLElBQUksQ0FBQyxHQUFHLFVBQVUsQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQzNDLElBQUksQ0FBQyxHQUFHLFVBQVUsQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBRTNDLE9BQU8sSUFBSSxXQUFXLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFBO0FBQzlCLENBQUMsQ0FBQTtBQUVELHVGQUF1RjtBQUN2RixXQUFXLENBQUMsb0JBQW9CLEdBQUcsVUFBVSxNQUFNO0lBQ2pELElBQUksUUFBUSxHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQTtJQUNsRCxJQUFJLFdBQVcsR0FBRyxRQUFRLEdBQUcsQ0FBQyxJQUFJLENBQUE7SUFFbEMsSUFBSSxXQUFXLElBQUksSUFBSSxJQUFJLFdBQVcsSUFBSSxJQUFJO1FBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyxtQkFBbUIsR0FBRyxRQUFRLENBQUMsQ0FBQTtJQUUvRixPQUFPO1FBQ0wsU0FBUyxFQUFFLFdBQVcsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNuRCxRQUFRLEVBQUUsUUFBUTtLQUNuQixDQUFBO0FBQ0gsQ0FBQyxDQUFBO0FBRUQsV0FBVyxDQUFDLFNBQVMsQ0FBQyxTQUFTLEdBQUcsVUFBVSxDQUFDLEVBQUUsVUFBVTtJQUN2RCxJQUFJLFVBQVUsRUFBRTtRQUNkLENBQUMsSUFBSSxDQUFDLENBQUE7S0FDUDtJQUVELENBQUMsSUFBSSxFQUFFLENBQUE7SUFFUCxJQUFJLE1BQU0sR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFBO0lBQzdCLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFBO0lBQ3ZCLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFBO0lBQzFCLE9BQU8sTUFBTSxDQUFBO0FBQ2YsQ0FBQyxDQUFBO0FBRUQsV0FBVyxDQUFDLFNBQVMsQ0FBQyxLQUFLLEdBQUc7SUFDNUIsSUFBSSxDQUFDLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLFlBQVksRUFBRSxDQUFDLENBQUE7SUFDMUMsSUFBSSxDQUFDLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLFlBQVksRUFBRSxDQUFDLENBQUE7SUFFMUMsT0FBTyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQTtBQUMzQixDQUFDLENBQUE7QUFFRCxXQUFXLENBQUMsU0FBUyxDQUFDLFVBQVUsR0FBRyxVQUFVLE1BQU0sRUFBRSxNQUFNO0lBQ3pELE1BQU0sR0FBRyxNQUFNLElBQUksTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQTtJQUNuQyxJQUFJLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFBO0lBQ3hDLElBQUksQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsTUFBTSxHQUFHLEVBQUUsQ0FBQyxDQUFBO0lBQzdDLE9BQU8sTUFBTSxDQUFBO0FBQ2YsQ0FBQyxDQUFBO0FBRUQsV0FBVyxDQUFDLFNBQVMsQ0FBQyxpQkFBaUIsR0FBRyxVQUFVLFFBQVE7SUFDMUQsSUFBSSxXQUFXLEdBQUcsUUFBUSxHQUFHLENBQUMsSUFBSSxDQUFBO0lBQ2xDLElBQUksV0FBVyxJQUFJLENBQUMsSUFBSSxXQUFXLElBQUksQ0FBQztRQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsbUJBQW1CLEdBQUcsUUFBUSxDQUFDLENBQUE7SUFFekYsSUFBSSxjQUFjLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQTtJQUNwQyxjQUFjLENBQUMsVUFBVSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQTtJQUV0QyxPQUFPLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLEVBQUUsY0FBYyxDQUFDLENBQUMsQ0FBQTtBQUN0RCxDQUFDLENBQUE7QUFFRCxNQUFNLENBQUMsT0FBTyxHQUFHLFdBQVcsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbInZhciBiaXA2NiA9IHJlcXVpcmUoJ2JpcDY2JylcbnZhciB0eXBlZm9yY2UgPSByZXF1aXJlKCd0eXBlZm9yY2UnKVxudmFyIHR5cGVzID0gcmVxdWlyZSgnLi90eXBlcycpXG5cbnZhciBCaWdJbnRlZ2VyID0gcmVxdWlyZSgnYmlnaScpXG5cbmZ1bmN0aW9uIEVDU2lnbmF0dXJlIChyLCBzKSB7XG4gIHR5cGVmb3JjZSh0eXBlcy50dXBsZSh0eXBlcy5CaWdJbnQsIHR5cGVzLkJpZ0ludCksIGFyZ3VtZW50cylcblxuICB0aGlzLnIgPSByXG4gIHRoaXMucyA9IHNcbn1cblxuRUNTaWduYXR1cmUucGFyc2VDb21wYWN0ID0gZnVuY3Rpb24gKGJ1ZmZlcikge1xuICB0eXBlZm9yY2UodHlwZXMuQnVmZmVyTig2NSksIGJ1ZmZlcilcblxuICB2YXIgZmxhZ0J5dGUgPSBidWZmZXIucmVhZFVJbnQ4KDApIC0gMjdcbiAgaWYgKGZsYWdCeXRlICE9PSAoZmxhZ0J5dGUgJiA3KSkgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHNpZ25hdHVyZSBwYXJhbWV0ZXInKVxuXG4gIHZhciBjb21wcmVzc2VkID0gISEoZmxhZ0J5dGUgJiA0KVxuICB2YXIgcmVjb3ZlcnlQYXJhbSA9IGZsYWdCeXRlICYgM1xuICB2YXIgc2lnbmF0dXJlID0gRUNTaWduYXR1cmUuZnJvbVJTQnVmZmVyKGJ1ZmZlci5zbGljZSgxKSlcblxuICByZXR1cm4ge1xuICAgIGNvbXByZXNzZWQ6IGNvbXByZXNzZWQsXG4gICAgaTogcmVjb3ZlcnlQYXJhbSxcbiAgICBzaWduYXR1cmU6IHNpZ25hdHVyZVxuICB9XG59XG5cbkVDU2lnbmF0dXJlLmZyb21SU0J1ZmZlciA9IGZ1bmN0aW9uIChidWZmZXIpIHtcbiAgdHlwZWZvcmNlKHR5cGVzLkJ1ZmZlck4oNjQpLCBidWZmZXIpXG5cbiAgdmFyIHIgPSBCaWdJbnRlZ2VyLmZyb21CdWZmZXIoYnVmZmVyLnNsaWNlKDAsIDMyKSlcbiAgdmFyIHMgPSBCaWdJbnRlZ2VyLmZyb21CdWZmZXIoYnVmZmVyLnNsaWNlKDMyLCA2NCkpXG4gIHJldHVybiBuZXcgRUNTaWduYXR1cmUociwgcylcbn1cblxuRUNTaWduYXR1cmUuZnJvbURFUiA9IGZ1bmN0aW9uIChidWZmZXIpIHtcbiAgdmFyIGRlY29kZSA9IGJpcDY2LmRlY29kZShidWZmZXIpXG4gIHZhciByID0gQmlnSW50ZWdlci5mcm9tREVSSW50ZWdlcihkZWNvZGUucilcbiAgdmFyIHMgPSBCaWdJbnRlZ2VyLmZyb21ERVJJbnRlZ2VyKGRlY29kZS5zKVxuXG4gIHJldHVybiBuZXcgRUNTaWduYXR1cmUociwgcylcbn1cblxuLy8gQklQNjI6IDEgYnl0ZSBoYXNoVHlwZSBmbGFnIChvbmx5IDB4MDEsIDB4MDIsIDB4MDMsIDB4ODEsIDB4ODIgYW5kIDB4ODMgYXJlIGFsbG93ZWQpXG5FQ1NpZ25hdHVyZS5wYXJzZVNjcmlwdFNpZ25hdHVyZSA9IGZ1bmN0aW9uIChidWZmZXIpIHtcbiAgdmFyIGhhc2hUeXBlID0gYnVmZmVyLnJlYWRVSW50OChidWZmZXIubGVuZ3RoIC0gMSlcbiAgdmFyIGhhc2hUeXBlTW9kID0gaGFzaFR5cGUgJiB+MHhjMFxuXG4gIGlmIChoYXNoVHlwZU1vZCA8PSAweDAwIHx8IGhhc2hUeXBlTW9kID49IDB4MDQpIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBoYXNoVHlwZSAnICsgaGFzaFR5cGUpXG5cbiAgcmV0dXJuIHtcbiAgICBzaWduYXR1cmU6IEVDU2lnbmF0dXJlLmZyb21ERVIoYnVmZmVyLnNsaWNlKDAsIC0xKSksXG4gICAgaGFzaFR5cGU6IGhhc2hUeXBlXG4gIH1cbn1cblxuRUNTaWduYXR1cmUucHJvdG90eXBlLnRvQ29tcGFjdCA9IGZ1bmN0aW9uIChpLCBjb21wcmVzc2VkKSB7XG4gIGlmIChjb21wcmVzc2VkKSB7XG4gICAgaSArPSA0XG4gIH1cblxuICBpICs9IDI3XG5cbiAgdmFyIGJ1ZmZlciA9IEJ1ZmZlci5hbGxvYyg2NSlcbiAgYnVmZmVyLndyaXRlVUludDgoaSwgMClcbiAgdGhpcy50b1JTQnVmZmVyKGJ1ZmZlciwgMSlcbiAgcmV0dXJuIGJ1ZmZlclxufVxuXG5FQ1NpZ25hdHVyZS5wcm90b3R5cGUudG9ERVIgPSBmdW5jdGlvbiAoKSB7XG4gIHZhciByID0gQnVmZmVyLmZyb20odGhpcy5yLnRvREVSSW50ZWdlcigpKVxuICB2YXIgcyA9IEJ1ZmZlci5mcm9tKHRoaXMucy50b0RFUkludGVnZXIoKSlcblxuICByZXR1cm4gYmlwNjYuZW5jb2RlKHIsIHMpXG59XG5cbkVDU2lnbmF0dXJlLnByb3RvdHlwZS50b1JTQnVmZmVyID0gZnVuY3Rpb24gKGJ1ZmZlciwgb2Zmc2V0KSB7XG4gIGJ1ZmZlciA9IGJ1ZmZlciB8fCBCdWZmZXIuYWxsb2MoNjQpXG4gIHRoaXMuci50b0J1ZmZlcigzMikuY29weShidWZmZXIsIG9mZnNldClcbiAgdGhpcy5zLnRvQnVmZmVyKDMyKS5jb3B5KGJ1ZmZlciwgb2Zmc2V0ICsgMzIpXG4gIHJldHVybiBidWZmZXJcbn1cblxuRUNTaWduYXR1cmUucHJvdG90eXBlLnRvU2NyaXB0U2lnbmF0dXJlID0gZnVuY3Rpb24gKGhhc2hUeXBlKSB7XG4gIHZhciBoYXNoVHlwZU1vZCA9IGhhc2hUeXBlICYgfjB4YzBcbiAgaWYgKGhhc2hUeXBlTW9kIDw9IDAgfHwgaGFzaFR5cGVNb2QgPj0gNCkgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGhhc2hUeXBlICcgKyBoYXNoVHlwZSlcblxuICB2YXIgaGFzaFR5cGVCdWZmZXIgPSBCdWZmZXIuYWxsb2MoMSlcbiAgaGFzaFR5cGVCdWZmZXIud3JpdGVVSW50OChoYXNoVHlwZSwgMClcblxuICByZXR1cm4gQnVmZmVyLmNvbmNhdChbdGhpcy50b0RFUigpLCBoYXNoVHlwZUJ1ZmZlcl0pXG59XG5cbm1vZHVsZS5leHBvcnRzID0gRUNTaWduYXR1cmVcbiJdfQ==