const typeforce = require('typeforce');
const types = require('../../types');
const version = require('./version');
const { BufferReader, BufferWriter } = require('../../bufferutils');
const NUM_JOINSPLITS_INPUTS = 2;
const NUM_JOINSPLITS_OUTPUTS = 2;
const NOTECIPHERTEXT_SIZE = 1 + 8 + 32 + 32 + 512 + 16;
const G1_PREFIX_MASK = 0x02;
const G2_PREFIX_MASK = 0x0a;
class ZcashBufferReader extends BufferReader {
    constructor(buffer, offset, txVersion) {
        super(buffer, offset);
        typeforce(types.maybe(types.Int32), txVersion);
        this.txVersion = txVersion;
    }
    readInt64() {
        const a = this.buffer.readUInt32LE(this.offset);
        let b = this.buffer.readInt32LE(this.offset + 4);
        b *= 0x100000000;
        this.offset += 8;
        return b + a;
    }
    readCompressedG1() {
        var yLsb = this.readUInt8() & 1;
        var x = this.readSlice(32);
        return {
            x: x,
            yLsb: yLsb
        };
    }
    readCompressedG2() {
        var yLsb = this.readUInt8() & 1;
        var x = this.readSlice(64);
        return {
            x: x,
            yLsb: yLsb
        };
    }
    readZKProof() {
        var zkproof;
        if (this.txVersion >= version.SAPLING) {
            zkproof = {
                sA: this.readSlice(48),
                sB: this.readSlice(96),
                sC: this.readSlice(48)
            };
        }
        else {
            zkproof = {
                gA: this.readCompressedG1(),
                gAPrime: this.readCompressedG1(),
                gB: this.readCompressedG2(),
                gBPrime: this.readCompressedG1(),
                gC: this.readCompressedG1(),
                gCPrime: this.readCompressedG1(),
                gK: this.readCompressedG1(),
                gH: this.readCompressedG1()
            };
        }
        return zkproof;
    }
    readJoinSplit() {
        var vpubOld = this.readUInt64();
        var vpubNew = this.readUInt64();
        var anchor = this.readSlice(32);
        var nullifiers = [];
        for (var j = 0; j < NUM_JOINSPLITS_INPUTS; j++) {
            nullifiers.push(this.readSlice(32));
        }
        var commitments = [];
        for (j = 0; j < NUM_JOINSPLITS_OUTPUTS; j++) {
            commitments.push(this.readSlice(32));
        }
        var ephemeralKey = this.readSlice(32);
        var randomSeed = this.readSlice(32);
        var macs = [];
        for (j = 0; j < NUM_JOINSPLITS_INPUTS; j++) {
            macs.push(this.readSlice(32));
        }
        var zkproof = this.readZKProof();
        var ciphertexts = [];
        for (j = 0; j < NUM_JOINSPLITS_OUTPUTS; j++) {
            ciphertexts.push(this.readSlice(NOTECIPHERTEXT_SIZE));
        }
        return {
            vpubOld: vpubOld,
            vpubNew: vpubNew,
            anchor: anchor,
            nullifiers: nullifiers,
            commitments: commitments,
            ephemeralKey: ephemeralKey,
            randomSeed: randomSeed,
            macs: macs,
            zkproof: zkproof,
            ciphertexts: ciphertexts
        };
    }
    readShieldedSpend() {
        var cv = this.readSlice(32);
        var anchor = this.readSlice(32);
        var nullifier = this.readSlice(32);
        var rk = this.readSlice(32);
        var zkproof = this.readZKProof();
        var spendAuthSig = this.readSlice(64);
        return {
            cv: cv,
            anchor: anchor,
            nullifier: nullifier,
            rk: rk,
            zkproof: zkproof,
            spendAuthSig: spendAuthSig
        };
    }
    readShieldedOutput() {
        var cv = this.readSlice(32);
        var cmu = this.readSlice(32);
        var ephemeralKey = this.readSlice(32);
        var encCiphertext = this.readSlice(580);
        var outCiphertext = this.readSlice(80);
        var zkproof = this.readZKProof();
        return {
            cv: cv,
            cmu: cmu,
            ephemeralKey: ephemeralKey,
            encCiphertext: encCiphertext,
            outCiphertext: outCiphertext,
            zkproof: zkproof
        };
    }
}
class ZcashBufferWriter extends BufferWriter {
    writeCompressedG1(i) {
        this.writeUInt8(G1_PREFIX_MASK | i.yLsb);
        this.writeSlice(i.x);
    }
    writeCompressedG2(i) {
        this.writeUInt8(G2_PREFIX_MASK | i.yLsb);
        this.writeSlice(i.x);
    }
}
module.exports = { ZcashBufferReader, ZcashBufferWriter };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVmZmVydXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvZm9ya3MvemNhc2gvYnVmZmVydXRpbHMuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsTUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFBO0FBQ3RDLE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQTtBQUNwQyxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUE7QUFFcEMsTUFBTSxFQUFFLFlBQVksRUFBRSxZQUFZLEVBQUUsR0FBRyxPQUFPLENBQUMsbUJBQW1CLENBQUMsQ0FBQTtBQUVuRSxNQUFNLHFCQUFxQixHQUFHLENBQUMsQ0FBQTtBQUMvQixNQUFNLHNCQUFzQixHQUFHLENBQUMsQ0FBQTtBQUNoQyxNQUFNLG1CQUFtQixHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxHQUFHLEdBQUcsRUFBRSxDQUFBO0FBRXRELE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQTtBQUMzQixNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUE7QUFFM0IsTUFBTSxpQkFBa0IsU0FBUSxZQUFZO0lBQzFDLFlBQWEsTUFBTSxFQUFFLE1BQU0sRUFBRSxTQUFTO1FBQ3BDLEtBQUssQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUE7UUFDckIsU0FBUyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxFQUFFLFNBQVMsQ0FBQyxDQUFBO1FBQzlDLElBQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFBO0lBQzVCLENBQUM7SUFFRCxTQUFTO1FBQ1AsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBQy9DLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxNQUFNLENB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QUFJLENBQUMsVUFBVSxDQUFDLGNBQWMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDeEMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDdEIsQ0FBQztDQUNGO0FBRUQsTUFBTSxDQUFDLE9BQU8sR0FBRyxFQUFFLGlCQUFpQixFQUFFLGlCQUFpQixFQUFFLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCB0eXBlZm9yY2UgPSByZXF1aXJlKCd0eXBlZm9yY2UnKVxuY29uc3QgdHlwZXMgPSByZXF1aXJlKCcuLi8uLi90eXBlcycpXG5jb25zdCB2ZXJzaW9uID0gcmVxdWlyZSgnLi92ZXJzaW9uJylcblxuY29uc3QgeyBCdWZmZXJSZWFkZXIsIEJ1ZmZlcldyaXRlciB9ID0gcmVxdWlyZSgnLi4vLi4vYnVmZmVydXRpbHMnKVxuXG5jb25zdCBOVU1fSk9JTlNQTElUU19JTlBVVFMgPSAyXG5jb25zdCBOVU1fSk9JTlNQTElUU19PVVRQVVRTID0gMlxuY29uc3QgTk9URUNJUEhFUlRFWFRfU0laRSA9IDEgKyA4ICsgMzIgKyAzMiArIDUxMiArIDE2XG5cbmNvbnN0IEcxX1BSRUZJWF9NQVNLID0gMHgwMlxuY29uc3QgRzJfUFJFRklYX01BU0sgPSAweDBhXG5cbmNsYXNzIFpjYXNoQnVmZmVyUmVhZGVyIGV4dGVuZHMgQnVmZmVyUmVhZGVyIHtcbiAgY29uc3RydWN0b3IgKGJ1ZmZlciwgb2Zmc2V0LCB0eFZlcnNpb24pIHtcbiAgICBzdXBlcihidWZmZXIsIG9mZnNldClcbiAgICB0eXBlZm9yY2UodHlwZXMubWF5YmUodHlwZXMuSW50MzIpLCB0eFZlcnNpb24pXG4gICAgdGhpcy50eFZlcnNpb24gPSB0eFZlcnNpb25cbiAgfVxuXG4gIHJlYWRJbnQ2NCAoKSB7XG4gICAgY29uc3QgYSA9IHRoaXMuYnVmZmVyLnJlYWRVSW50MzJMRSh0aGlzLm9mZnNldClcbiAgICBsZXQgYiA9IHRoaXMuYnVmZmVyLnJlYWRJbnQzMkxFKHRoaXMub2Zmc2V0ICsgNClcbiAgICBiICo9IDB4MTAwMDAwMDAwXG4gICAgdGhpcy5vZmZzZXQgKz0gOFxuICAgIHJldHVybiBiICsgYVxuICB9XG5cbiAgcmVhZENvbXByZXNzZWRHMSAoKSB7XG4gICAgdmFyIHlMc2IgPSB0aGlzLnJlYWRVSW50OCgpICYgMVxuICAgIHZhciB4ID0gdGhpcy5yZWFkU2xpY2UoMzIpXG4gICAgcmV0dXJuIHtcbiAgICAgIHg6IHgsXG4gICAgICB5THNiOiB5THNiXG4gICAgfVxuICB9XG5cbiAgcmVhZENvbXByZXNzZWRHMiAoKSB7XG4gICAgdmFyIHlMc2IgPSB0aGlzLnJlYWRVSW50OCgpICYgMVxuICAgIHZhciB4ID0gdGhpcy5yZWFkU2xpY2UoNjQpXG4gICAgcmV0dXJuIHtcbiAgICAgIHg6IHgsXG4gICAgICB5THNiOiB5THNiXG4gICAgfVxuICB9XG5cbiAgcmVhZFpLUHJvb2YgKCkge1xuICAgIHZhciB6a3Byb29mXG4gICAgaWYgKHRoaXMudHhWZXJzaW9uID49IHZlcnNpb24uU0FQTElORykge1xuICAgICAgemtwcm9vZiA9IHtcbiAgICAgICAgc0E6IHRoaXMucmVhZFNsaWNlKDQ4KSxcbiAgICAgICAgc0I6IHRoaXMucmVhZFNsaWNlKDk2KSxcbiAgICAgICAgc0M6IHRoaXMucmVhZFNsaWNlKDQ4KVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB6a3Byb29mID0ge1xuICAgICAgICBnQTogdGhpcy5yZWFkQ29tcHJlc3NlZEcxKCksXG4gICAgICAgIGdBUHJpbWU6IHRoaXMucmVhZENvbXByZXNzZWRHMSgpLFxuICAgICAgICBnQjogdGhpcy5yZWFkQ29tcHJlc3NlZEcyKCksXG4gICAgICAgIGdCUHJpbWU6IHRoaXMucmVhZENvbXByZXNzZWRHMSgpLFxuICAgICAgICBnQzogdGhpcy5yZWFkQ29tcHJlc3NlZEcxKCksXG4gICAgICAgIGdDUHJpbWU6IHRoaXMucmVhZENvbXByZXNzZWRHMSgpLFxuICAgICAgICBnSzogdGhpcy5yZWFkQ29tcHJlc3NlZEcxKCksXG4gICAgICAgIGdIOiB0aGlzLnJlYWRDb21wcmVzc2VkRzEoKVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gemtwcm9vZlxuICB9XG5cbiAgcmVhZEpvaW5TcGxpdCAoKSB7XG4gICAgdmFyIHZwdWJPbGQgPSB0aGlzLnJlYWRVSW50NjQoKVxuICAgIHZhciB2cHViTmV3ID0gdGhpcy5yZWFkVUludDY0KClcbiAgICB2YXIgYW5jaG9yID0gdGhpcy5yZWFkU2xpY2UoMzIpXG4gICAgdmFyIG51bGxpZmllcnMgPSBbXVxuICAgIGZvciAodmFyIGogPSAwOyBqIDwgTlVNX0pPSU5TUExJVFNfSU5QVVRTOyBqKyspIHtcbiAgICAgIG51bGxpZmllcnMucHVzaCh0aGlzLnJlYWRTbGljZSgzMikpXG4gICAgfVxuICAgIHZhciBjb21taXRtZW50cyA9IFtdXG4gICAgZm9yIChqID0gMDsgaiA8IE5VTV9KT0lOU1BMSVRTX09VVFBVVFM7IGorKykge1xuICAgICAgY29tbWl0bWVudHMucHVzaCh0aGlzLnJlYWRTbGljZSgzMikpXG4gICAgfVxuICAgIHZhciBlcGhlbWVyYWxLZXkgPSB0aGlzLnJlYWRTbGljZSgzMilcbiAgICB2YXIgcmFuZG9tU2VlZCA9IHRoaXMucmVhZFNsaWNlKDMyKVxuICAgIHZhciBtYWNzID0gW11cbiAgICBmb3IgKGogPSAwOyBqIDwgTlVNX0pPSU5TUExJVFNfSU5QVVRTOyBqKyspIHtcbiAgICAgIG1hY3MucHVzaCh0aGlzLnJlYWRTbGljZSgzMikpXG4gICAgfVxuXG4gICAgdmFyIHprcHJvb2YgPSB0aGlzLnJlYWRaS1Byb29mKClcbiAgICB2YXIgY2lwaGVydGV4dHMgPSBbXVxuICAgIGZvciAoaiA9IDA7IGogPCBOVU1fSk9JTlNQTElUU19PVVRQVVRTOyBqKyspIHtcbiAgICAgIGNpcGhlcnRleHRzLnB1c2godGhpcy5yZWFkU2xpY2UoTk9URUNJUEhFUlRFWFRfU0laRSkpXG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICB2cHViT2xkOiB2cHViT2xkLFxuICAgICAgdnB1Yk5ldzogdnB1Yk5ldyxcbiAgICAgIGFuY2hvcjogYW5jaG9yLFxuICAgICAgbnVsbGlmaWVyczogbnVsbGlmaWVycyxcbiAgICAgIGNvbW1pdG1lbnRzOiBjb21taXRtZW50cyxcbiAgICAgIGVwaGVtZXJhbEtleTogZXBoZW1lcmFsS2V5LFxuICAgICAgcmFuZG9tU2VlZDogcmFuZG9tU2VlZCxcbiAgICAgIG1hY3M6IG1hY3MsXG4gICAgICB6a3Byb29mOiB6a3Byb29mLFxuICAgICAgY2lwaGVydGV4dHM6IGNpcGhlcnRleHRzXG4gICAgfVxuICB9XG5cbiAgcmVhZFNoaWVsZGVkU3BlbmQgKCkge1xuICAgIHZhciBjdiA9IHRoaXMucmVhZFNsaWNlKDMyKVxuICAgIHZhciBhbmNob3IgPSB0aGlzLnJlYWRTbGljZSgzMilcbiAgICB2YXIgbnVsbGlmaWVyID0gdGhpcy5yZWFkU2xpY2UoMzIpXG4gICAgdmFyIHJrID0gdGhpcy5yZWFkU2xpY2UoMzIpXG4gICAgdmFyIHprcHJvb2YgPSB0aGlzLnJlYWRaS1Byb29mKClcbiAgICB2YXIgc3BlbmRBdXRoU2lnID0gdGhpcy5yZWFkU2xpY2UoNjQpXG4gICAgcmV0dXJuIHtcbiAgICAgIGN2OiBjdixcbiAgICAgIGFuY2hvcjogYW5jaG9yLFxuICAgICAgbnVsbGlmaWVyOiBudWxsaWZpZXIsXG4gICAgICByazogcmssXG4gICAgICB6a3Byb29mOiB6a3Byb29mLFxuICAgICAgc3BlbmRBdXRoU2lnOiBzcGVuZEF1dGhTaWdcbiAgICB9XG4gIH1cblxuICByZWFkU2hpZWxkZWRPdXRwdXQgKCkge1xuICAgIHZhciBjdiA9IHRoaXMucmVhZFNsaWNlKDMyKVxuICAgIHZhciBjbXUgPSB0aGlzLnJlYWRTbGljZSgzMilcbiAgICB2YXIgZXBoZW1lcmFsS2V5ID0gdGhpcy5yZWFkU2xpY2UoMzIpXG4gICAgdmFyIGVuY0NpcGhlcnRleHQgPSB0aGlzLnJlYWRTbGljZSg1ODApXG4gICAgdmFyIG91dENpcGhlcnRleHQgPSB0aGlzLnJlYWRTbGljZSg4MClcbiAgICB2YXIgemtwcm9vZiA9IHRoaXMucmVhZFpLUHJvb2YoKVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIGN2OiBjdixcbiAgICAgIGNtdTogY211LFxuICAgICAgZXBoZW1lcmFsS2V5OiBlcGhlbWVyYWxLZXksXG4gICAgICBlbmNDaXBoZXJ0ZXh0OiBlbmNDaXBoZXJ0ZXh0LFxuICAgICAgb3V0Q2lwaGVydGV4dDogb3V0Q2lwaGVydGV4dCxcbiAgICAgIHprcHJvb2Y6IHprcHJvb2ZcbiAgICB9XG4gIH1cbn1cblxuY2xhc3MgWmNhc2hCdWZmZXJXcml0ZXIgZXh0ZW5kcyBCdWZmZXJXcml0ZXIge1xuICB3cml0ZUNvbXByZXNzZWRHMSAoaSkge1xuICAgIHRoaXMud3JpdGVVSW50OChHMV9QUkVGSVhfTUFTSyB8IGkueUxzYilcbiAgICB0aGlzLndyaXRlU2xpY2UoaS54KVxuICB9XG5cbiAgd3JpdGVDb21wcmVzc2VkRzIgKGkpIHtcbiAgICB0aGlzLndyaXRlVUludDgoRzJfUFJFRklYX01BU0sgfCBpLnlMc2IpXG4gICAgdGhpcy53cml0ZVNsaWNlKGkueClcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHsgWmNhc2hCdWZmZXJSZWFkZXIsIFpjYXNoQnVmZmVyV3JpdGVyIH1cbiJdfQ==