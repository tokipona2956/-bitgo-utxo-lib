var Buffer = require('safe-buffer').Buffer;
var bip66 = require('bip66');
var pushdata = require('pushdata-bitcoin');
var typeforce = require('typeforce');
var types = require('./types');
var scriptNumber = require('./script_number');
var OPS = require('bitcoin-ops');
var REVERSE_OPS = require('bitcoin-ops/map');
var OP_INT_BASE = OPS.OP_RESERVED; // OP_1 - 1
function isOPInt(value) {
    return types.Number(value) &&
        ((value === OPS.OP_0) ||
            (value >= OPS.OP_1 && value <= OPS.OP_16) ||
            (value === OPS.OP_1NEGATE));
}
function isPushOnlyChunk(value) {
    return types.Buffer(value) || isOPInt(value);
}
function isPushOnly(value) {
    return types.Array(value) && value.every(isPushOnlyChunk);
}
function asMinimalOP(buffer) {
    if (buffer.length === 0)
        return OPS.OP_0;
    if (buffer.length !== 1)
        return;
    if (buffer[0] >= 1 && buffer[0] <= 16)
        return OP_INT_BASE + buffer[0];
    if (buffer[0] === 0x81)
        return OPS.OP_1NEGATE;
}
function compile(chunks) {
    // TODO: remove me
    if (Buffer.isBuffer(chunks))
        return chunks;
    typeforce(types.Array, chunks);
    var bufferSize = chunks.reduce(function (accum, chunk) {
        // data chunk
        if (Buffer.isBuffer(chunk)) {
            // adhere to BIP62.3, minimal push policy
            if (chunk.length === 1 && asMinimalOP(chunk) !== undefined) {
                return accum + 1;
            }
            return accum + pushdata.encodingLength(chunk.length) + chunk.length;
        }
        // opcode
        return accum + 1;
    }, 0.0);
    var buffer = Buffer.allocUnsafe(bufferSize);
    var offset = 0;
    chunks.forEach(function (chunk) {
        // data chunk
        if (Buffer.isBuffer(chunk)) {
            // adhere to BIP62.3, minimal push policy
            var opcode = asMinimalOP(chunk);
            if (opcode !== undefined) {
                buffer.writeUInt8(opcode, offset);
                offset += 1;
                return;
            }
            offset += pushdata.encode(buffer, chunk.length, offset);
            chunk.copy(buffer, offset);
            offset += chunk.length;
            // opcode
        }
        else {
            buffer.writeUInt8(chunk, offset);
            offset += 1;
        }
    });
    if (offset !== buffer.length)
        throw new Error('Could not decode chunks');
    return buffer;
}
function decompile(buffer) {
    // TODO: remove me
    if (types.Array(buffer))
        return buffer;
    typeforce(types.Buffer, buffer);
    var chunks = [];
    var i = 0;
    while (i < buffer.length) {
        var opcode = buffer[i];
        // data chunk
        if ((opcode > OPS.OP_0) && (opcode <= OPS.OP_PUSHDATA4)) {
            var d = pushdata.decode(buffer, i);
            // did reading a pushDataInt fail? empty script
            if (d === null)
                return [];
            i += d.size;
            // attempt to read too much data? empty script
            if (i + d.number > buffer.length)
                return [];
            var data = buffer.slice(i, i + d.number);
            i += d.number;
            // decompile minimally
            var op = asMinimalOP(data);
            if (op !== undefined) {
                chunks.push(op);
            }
            else {
                chunks.push(data);
            }
            // opcode
        }
        else {
            chunks.push(opcode);
            i += 1;
        }
    }
    return chunks;
}
function toASM(chunks) {
    if (Buffer.isBuffer(chunks)) {
        chunks = decompile(chunks);
    }
    return chunks.map(function (chunk) {
        // data?
        if (Buffer.isBuffer(chunk)) {
            var op = asMinimalOP(chunk);
            if (op === undefined)
                return chunk.toString('hex');
            chunk = op;
        }
        // opcode!
        return REVERSE_OPS[chunk];
    }).join(' ');
}
function fromASM(asm) {
    typeforce(types.String, asm);
    return compile(asm.split(' ').map(function (chunkStr) {
        // opcode?
        if (OPS[chunkStr] !== undefined)
            return OPS[chunkStr];
        typeforce(types.Hex, chunkStr);
        // data!
        return Buffer.from(chunkStr, 'hex');
    }));
}
function toStack(chunks) {
    chunks = decompile(chunks);
    typeforce(isPushOnly, chunks);
    return chunks.map(function (op) {
        if (Buffer.isBuffer(op))
            return op;
        if (op === OPS.OP_0)
            return Buffer.allocUnsafe(0);
        return scriptNumber.encode(op - OP_INT_BASE);
    });
}
function isCanonicalPubKey(buffer) {
    if (!Buffer.isBuffer(buffer))
        return false;
    if (buffer.length < 33)
        return false;
    switch (buffer[0]) {
        case 0x02:
        case 0x03:
            return buffer.length === 33;
        case 0x04:
            return buffer.length === 65;
    }
    return false;
}
function isDefinedHashType(hashType) {
    var hashTypeMod = hashType & ~0xc0;
    // return hashTypeMod > SIGHASH_ALL && hashTypeMod < SIGHASH_SINGLE
    return hashTypeMod > 0x00 && hashTypeMod < 0x04;
}
function isCanonicalSignature(buffer) {
    if (!Buffer.isBuffer(buffer))
        return false;
    if (!isDefinedHashType(buffer[buffer.length - 1]))
        return false;
    return bip66.check(buffer.slice(0, -1));
}
module.exports = {
    compile: compile,
    decompile: decompile,
    fromASM: fromASM,
    toASM: toASM,
    toStack: toStack,
    number: require('./script_number'),
    isCanonicalPubKey: isCanonicalPubKey,
    isCanonicalSignature: isCanonicalSignature,
    isPushOnly: isPushOnly,
    isDefinedHashType: isDefinedHashType
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NyaXB0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3NjcmlwdC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUMsTUFBTSxDQUFBO0FBQzFDLElBQUksS0FBSyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQTtBQUM1QixJQUFJLFFBQVEsR0FBRyxPQUFPLENBQUMsa0JBQWtCLENBQUMsQ0FBQTtBQUMxQyxJQUFJLFNBQVMsR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUE7QUFDcEMsSUFBSSxLQUFLLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFBO0FBQzlCLElBQUksWUFBWSxHQUFHLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFBO0FBRTdDLElBQUksR0FBRyxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQTtBQUNoQyxJQUFJLFdBQVcsR0FBRyxPQUFPLENBQUMsaUJBQWlCLENBQUMsQ0FBQTtBQUM1QyxJQUFJLFdBQVcsR0FBRyxHQUFHLENBQUMsV0FBVyxDQUFBLENBQUMsV0FBVztBQUU3QyxTQUFTLE9BQU8sQ0FBRSxLQUFLO0lBQ3JCLE9BQU8sS0FBSyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUM7UUFDeEIsQ0FBQyxDQUFDLEtBQUssS0FBSyxHQUFHLENBQUMsSUFBSSxDQUFDO1lBQ3JCLENBQUMsS0FBSyxJQUFJLEdBQUcsQ0FBQyxJQUFJLElBQUksS0FBSyxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUM7WUFDekMsQ0FBQyxLQUFLLEtBQUssR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUE7QUFDL0IsQ0FBQztBQUVELFNBQVMsZUFBZSxDQUFFLEtBQUs7SUFDN0IsT0FBTyxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQTtBQUM5QyxDQUFDO0FBRUQsU0FB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QUFJLENBQUE7SUFFcEMsbUVBQW1FO0lBQ2pFLE9BQU8sV0FBVyxHQUFHLElBQUksSUFBSSxXQUFXLEdBQUcsSUFBSSxDQUFBO0FBQ2pELENBQUM7QUFFRCxTQUFTLG9CQUFvQixDQUFFLE1BQU07SUFDbkMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDO1FBQUUsT0FBTyxLQUFLLENBQUE7SUFDMUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQUUsT0FBTyxLQUFLLENBQUE7SUFFL0QsT0FBTyxLQUFLLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtBQUN6QyxDQUFDO0FBRUQsTUFBTSxDQUFDLE9BQU8sR0FBRztJQUNmLE9BQU8sRUFBRSxPQUFPO0lBQ2hCLFNBQVMsRUFBRSxTQUFTO0lBQ3BCLE9BQU8sRUFBRSxPQUFPO0lBQ2hCLEtBQUssRUFBRSxLQUFLO0lBQ1osT0FBTyxFQUFFLE9BQU87SUFFaEIsTUFBTSxFQUFFLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQztJQUVsQyxpQkFBaUIsRUFBRSxpQkFBaUI7SUFDcEMsb0JBQW9CLEVBQUUsb0JBQW9CO0lBQzFDLFVBQVUsRUFBRSxVQUFVO0lBQ3RCLGlCQUFpQixFQUFFLGlCQUFpQjtDQUNyQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsidmFyIEJ1ZmZlciA9IHJlcXVpcmUoJ3NhZmUtYnVmZmVyJykuQnVmZmVyXG52YXIgYmlwNjYgPSByZXF1aXJlKCdiaXA2NicpXG52YXIgcHVzaGRhdGEgPSByZXF1aXJlKCdwdXNoZGF0YS1iaXRjb2luJylcbnZhciB0eXBlZm9yY2UgPSByZXF1aXJlKCd0eXBlZm9yY2UnKVxudmFyIHR5cGVzID0gcmVxdWlyZSgnLi90eXBlcycpXG52YXIgc2NyaXB0TnVtYmVyID0gcmVxdWlyZSgnLi9zY3JpcHRfbnVtYmVyJylcblxudmFyIE9QUyA9IHJlcXVpcmUoJ2JpdGNvaW4tb3BzJylcbnZhciBSRVZFUlNFX09QUyA9IHJlcXVpcmUoJ2JpdGNvaW4tb3BzL21hcCcpXG52YXIgT1BfSU5UX0JBU0UgPSBPUFMuT1BfUkVTRVJWRUQgLy8gT1BfMSAtIDFcblxuZnVuY3Rpb24gaXNPUEludCAodmFsdWUpIHtcbiAgcmV0dXJuIHR5cGVzLk51bWJlcih2YWx1ZSkgJiZcbiAgICAoKHZhbHVlID09PSBPUFMuT1BfMCkgfHxcbiAgICAodmFsdWUgPj0gT1BTLk9QXzEgJiYgdmFsdWUgPD0gT1BTLk9QXzE2KSB8fFxuICAgICh2YWx1ZSA9PT0gT1BTLk9QXzFORUdBVEUpKVxufVxuXG5mdW5jdGlvbiBpc1B1c2hPbmx5Q2h1bmsgKHZhbHVlKSB7XG4gIHJldHVybiB0eXBlcy5CdWZmZXIodmFsdWUpIHx8IGlzT1BJbnQodmFsdWUpXG59XG5cbmZ1bmN0aW9uIGlzUHVzaE9ubHkgKHZhbHVlKSB7XG4gIHJldHVybiB0eXBlcy5BcnJheSh2YWx1ZSkgJiYgdmFsdWUuZXZlcnkoaXNQdXNoT25seUNodW5rKVxufVxuXG5mdW5jdGlvbiBhc01pbmltYWxPUCAoYnVmZmVyKSB7XG4gIGlmIChidWZmZXIubGVuZ3RoID09PSAwKSByZXR1cm4gT1BTLk9QXzBcbiAgaWYgKGJ1ZmZlci5sZW5ndGggIT09IDEpIHJldHVyblxuICBpZiAoYnVmZmVyWzBdID49IDEgJiYgYnVmZmVyWzBdIDw9IDE2KSByZXR1cm4gT1BfSU5UX0JBU0UgKyBidWZmZXJbMF1cbiAgaWYgKGJ1ZmZlclswXSA9PT0gMHg4MSkgcmV0dXJuIE9QUy5PUF8xTkVHQVRFXG59XG5cbmZ1bmN0aW9uIGNvbXBpbGUgKGNodW5rcykge1xuICAvLyBUT0RPOiByZW1vdmUgbWVcbiAgaWYgKEJ1ZmZlci5pc0J1ZmZlcihjaHVua3MpKSByZXR1cm4gY2h1bmtzXG5cbiAgdHlwZWZvcmNlKHR5cGVzLkFycmF5LCBjaHVua3MpXG5cbiAgdmFyIGJ1ZmZlclNpemUgPSBjaHVua3MucmVkdWNlKGZ1bmN0aW9uIChhY2N1bSwgY2h1bmspIHtcbiAgICAvLyBkYXRhIGNodW5rXG4gICAgaWYgKEJ1ZmZlci5pc0J1ZmZlcihjaHVuaykpIHtcbiAgICAgIC8vIGFkaGVyZSB0byBCSVA2Mi4zLCBtaW5pbWFsIHB1c2ggcG9saWN5XG4gICAgICBpZiAoY2h1bmsubGVuZ3RoID09PSAxICYmIGFzTWluaW1hbE9QKGNodW5rKSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHJldHVybiBhY2N1bSArIDFcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGFjY3VtICsgcHVzaGRhdGEuZW5jb2RpbmdMZW5ndGgoY2h1bmsubGVuZ3RoKSArIGNodW5rLmxlbmd0aFxuICAgIH1cblxuICAgIC8vIG9wY29kZVxuICAgIHJldHVybiBhY2N1bSArIDFcbiAgfSwgMC4wKVxuXG4gIHZhciBidWZmZXIgPSBCdWZmZXIuYWxsb2NVbnNhZmUoYnVmZmVyU2l6ZSlcbiAgdmFyIG9mZnNldCA9IDBcblxuICBjaHVua3MuZm9yRWFjaChmdW5jdGlvbiAoY2h1bmspIHtcbiAgICAvLyBkYXRhIGNodW5rXG4gICAgaWYgKEJ1ZmZlci5pc0J1ZmZlcihjaHVuaykpIHtcbiAgICAgIC8vIGFkaGVyZSB0byBCSVA2Mi4zLCBtaW5pbWFsIHB1c2ggcG9saWN5XG4gICAgICB2YXIgb3Bjb2RlID0gYXNNaW5pbWFsT1AoY2h1bmspXG4gICAgICBpZiAob3Bjb2RlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgYnVmZmVyLndyaXRlVUludDgob3Bjb2RlLCBvZmZzZXQpXG4gICAgICAgIG9mZnNldCArPSAxXG4gICAgICAgIHJldHVyblxuICAgICAgfVxuXG4gICAgICBvZmZzZXQgKz0gcHVzaGRhdGEuZW5jb2RlKGJ1ZmZlciwgY2h1bmsubGVuZ3RoLCBvZmZzZXQpXG4gICAgICBjaHVuay5jb3B5KGJ1ZmZlciwgb2Zmc2V0KVxuICAgICAgb2Zmc2V0ICs9IGNodW5rLmxlbmd0aFxuXG4gICAgLy8gb3Bjb2RlXG4gICAgfSBlbHNlIHtcbiAgICAgIGJ1ZmZlci53cml0ZVVJbnQ4KGNodW5rLCBvZmZzZXQpXG4gICAgICBvZmZzZXQgKz0gMVxuICAgIH1cbiAgfSlcblxuICBpZiAob2Zmc2V0ICE9PSBidWZmZXIubGVuZ3RoKSB0aHJvdyBuZXcgRXJyb3IoJ0NvdWxkIG5vdCBkZWNvZGUgY2h1bmtzJylcbiAgcmV0dXJuIGJ1ZmZlclxufVxuXG5mdW5jdGlvbiBkZWNvbXBpbGUgKGJ1ZmZlcikge1xuICAvLyBUT0RPOiByZW1vdmUgbWVcbiAgaWYgKHR5cGVzLkFycmF5KGJ1ZmZlcikpIHJldHVybiBidWZmZXJcblxuICB0eXBlZm9yY2UodHlwZXMuQnVmZmVyLCBidWZmZXIpXG5cbiAgdmFyIGNodW5rcyA9IFtdXG4gIHZhciBpID0gMFxuXG4gIHdoaWxlIChpIDwgYnVmZmVyLmxlbmd0aCkge1xuICAgIHZhciBvcGNvZGUgPSBidWZmZXJbaV1cblxuICAgIC8vIGRhdGEgY2h1bmtcbiAgICBpZiAoKG9wY29kZSA+IE9QUy5PUF8wKSAmJiAob3Bjb2RlIDw9IE9QUy5PUF9QVVNIREFUQTQpKSB7XG4gICAgICB2YXIgZCA9IHB1c2hkYXRhLmRlY29kZShidWZmZXIsIGkpXG5cbiAgICAgIC8vIGRpZCByZWFkaW5nIGEgcHVzaERhdGFJbnQgZmFpbD8gZW1wdHkgc2NyaXB0XG4gICAgICBpZiAoZCA9PT0gbnVsbCkgcmV0dXJuIFtdXG4gICAgICBpICs9IGQuc2l6ZVxuXG4gICAgICAvLyBhdHRlbXB0IHRvIHJlYWQgdG9vIG11Y2ggZGF0YT8gZW1wdHkgc2NyaXB0XG4gICAgICBpZiAoaSArIGQubnVtYmVyID4gYnVmZmVyLmxlbmd0aCkgcmV0dXJuIFtdXG5cbiAgICAgIHZhciBkYXRhID0gYnVmZmVyLnNsaWNlKGksIGkgKyBkLm51bWJlcilcbiAgICAgIGkgKz0gZC5udW1iZXJcblxuICAgICAgLy8gZGVjb21waWxlIG1pbmltYWxseVxuICAgICAgdmFyIG9wID0gYXNNaW5pbWFsT1AoZGF0YSlcbiAgICAgIGlmIChvcCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGNodW5rcy5wdXNoKG9wKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY2h1bmtzLnB1c2goZGF0YSlcbiAgICAgIH1cblxuICAgIC8vIG9wY29kZVxuICAgIH0gZWxzZSB7XG4gICAgICBjaHVua3MucHVzaChvcGNvZGUpXG5cbiAgICAgIGkgKz0gMVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiBjaHVua3Ncbn1cblxuZnVuY3Rpb24gdG9BU00gKGNodW5rcykge1xuICBpZiAoQnVmZmVyLmlzQnVmZmVyKGNodW5rcykpIHtcbiAgICBjaHVua3MgPSBkZWNvbXBpbGUoY2h1bmtzKVxuICB9XG5cbiAgcmV0dXJuIGNodW5rcy5tYXAoZnVuY3Rpb24gKGNodW5rKSB7XG4gICAgLy8gZGF0YT9cbiAgICBpZiAoQnVmZmVyLmlzQnVmZmVyKGNodW5rKSkge1xuICAgICAgdmFyIG9wID0gYXNNaW5pbWFsT1AoY2h1bmspXG4gICAgICBpZiAob3AgPT09IHVuZGVmaW5lZCkgcmV0dXJuIGNodW5rLnRvU3RyaW5nKCdoZXgnKVxuICAgICAgY2h1bmsgPSBvcFxuICAgIH1cblxuICAgIC8vIG9wY29kZSFcbiAgICByZXR1cm4gUkVWRVJTRV9PUFNbY2h1bmtdXG4gIH0pLmpvaW4oJyAnKVxufVxuXG5mdW5jdGlvbiBmcm9tQVNNIChhc20pIHtcbiAgdHlwZWZvcmNlKHR5cGVzLlN0cmluZywgYXNtKVxuXG4gIHJldHVybiBjb21waWxlKGFzbS5zcGxpdCgnICcpLm1hcChmdW5jdGlvbiAoY2h1bmtTdHIpIHtcbiAgICAvLyBvcGNvZGU/XG4gICAgaWYgKE9QU1tjaHVua1N0cl0gIT09IHVuZGVmaW5lZCkgcmV0dXJuIE9QU1tjaHVua1N0cl1cbiAgICB0eXBlZm9yY2UodHlwZXMuSGV4LCBjaHVua1N0cilcblxuICAgIC8vIGRhdGEhXG4gICAgcmV0dXJuIEJ1ZmZlci5mcm9tKGNodW5rU3RyLCAnaGV4JylcbiAgfSkpXG59XG5cbmZ1bmN0aW9uIHRvU3RhY2sgKGNodW5rcykge1xuICBjaHVua3MgPSBkZWNvbXBpbGUoY2h1bmtzKVxuICB0eXBlZm9yY2UoaXNQdXNoT25seSwgY2h1bmtzKVxuXG4gIHJldHVybiBjaHVua3MubWFwKGZ1bmN0aW9uIChvcCkge1xuICAgIGlmIChCdWZmZXIuaXNCdWZmZXIob3ApKSByZXR1cm4gb3BcbiAgICBpZiAob3AgPT09IE9QUy5PUF8wKSByZXR1cm4gQnVmZmVyLmFsbG9jVW5zYWZlKDApXG5cbiAgICByZXR1cm4gc2NyaXB0TnVtYmVyLmVuY29kZShvcCAtIE9QX0lOVF9CQVNFKVxuICB9KVxufVxuXG5mdW5jdGlvbiBpc0Nhbm9uaWNhbFB1YktleSAoYnVmZmVyKSB7XG4gIGlmICghQnVmZmVyLmlzQnVmZmVyKGJ1ZmZlcikpIHJldHVybiBmYWxzZVxuICBpZiAoYnVmZmVyLmxlbmd0aCA8IDMzKSByZXR1cm4gZmFsc2VcblxuICBzd2l0Y2ggKGJ1ZmZlclswXSkge1xuICAgIGNhc2UgMHgwMjpcbiAgICBjYXNlIDB4MDM6XG4gICAgICByZXR1cm4gYnVmZmVyLmxlbmd0aCA9PT0gMzNcbiAgICBjYXNlIDB4MDQ6XG4gICAgICByZXR1cm4gYnVmZmVyLmxlbmd0aCA9PT0gNjVcbiAgfVxuXG4gIHJldHVybiBmYWxzZVxufVxuXG5mdW5jdGlvbiBpc0RlZmluZWRIYXNoVHlwZSAoaGFzaFR5cGUpIHtcbiAgdmFyIGhhc2hUeXBlTW9kID0gaGFzaFR5cGUgJiB+MHhjMFxuXG4vLyByZXR1cm4gaGFzaFR5cGVNb2QgPiBTSUdIQVNIX0FMTCAmJiBoYXNoVHlwZU1vZCA8IFNJR0hBU0hfU0lOR0xFXG4gIHJldHVybiBoYXNoVHlwZU1vZCA+IDB4MDAgJiYgaGFzaFR5cGVNb2QgPCAweDA0XG59XG5cbmZ1bmN0aW9uIGlzQ2Fub25pY2FsU2lnbmF0dXJlIChidWZmZXIpIHtcbiAgaWYgKCFCdWZmZXIuaXNCdWZmZXIoYnVmZmVyKSkgcmV0dXJuIGZhbHNlXG4gIGlmICghaXNEZWZpbmVkSGFzaFR5cGUoYnVmZmVyW2J1ZmZlci5sZW5ndGggLSAxXSkpIHJldHVybiBmYWxzZVxuXG4gIHJldHVybiBiaXA2Ni5jaGVjayhidWZmZXIuc2xpY2UoMCwgLTEpKVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgY29tcGlsZTogY29tcGlsZSxcbiAgZGVjb21waWxlOiBkZWNvbXBpbGUsXG4gIGZyb21BU006IGZyb21BU00sXG4gIHRvQVNNOiB0b0FTTSxcbiAgdG9TdGFjazogdG9TdGFjayxcblxuICBudW1iZXI6IHJlcXVpcmUoJy4vc2NyaXB0X251bWJlcicpLFxuXG4gIGlzQ2Fub25pY2FsUHViS2V5OiBpc0Nhbm9uaWNhbFB1YktleSxcbiAgaXNDYW5vbmljYWxTaWduYXR1cmU6IGlzQ2Fub25pY2FsU2lnbmF0dXJlLFxuICBpc1B1c2hPbmx5OiBpc1B1c2hPbmx5LFxuICBpc0RlZmluZWRIYXNoVHlwZTogaXNEZWZpbmVkSGFzaFR5cGVcbn1cbiJdfQ==